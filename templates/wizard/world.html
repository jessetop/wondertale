{% extends "wizard/base_wizard.html" %}

{% set current_step = 3 %}

{% block title %}Story World - WonderTales Wizard{% endblock %}

{% block wizard_content %}
<h1 class="step-title">Where does your adventure happen? ğŸ—ºï¸</h1>
<p class="step-subtitle">Choose your magical world!</p>

<form id="worldForm">
    <div class="selection-grid">
        <button type="button" class="selection-btn" data-value="space">
            <span class="selection-icon">ğŸš€</span>
            <span class="selection-text">Outer Space<br><small style="opacity: 0.8;">Rockets, planets & stars</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="community">
            <span class="selection-icon">ğŸ˜ï¸</span>
            <span class="selection-text">Community<br><small style="opacity: 0.8;">Helping friends & neighbors</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="dragons">
            <span class="selection-icon">ğŸ‰</span>
            <span class="selection-text">Dragon Land<br><small style="opacity: 0.8;">Friendly dragons & magic</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="fairies">
            <span class="selection-icon">ğŸ§š</span>
            <span class="selection-text">Fairy Garden<br><small style="opacity: 0.8;">Fairies, flowers & magic</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="pirates">
            <span class="selection-icon">ğŸ´â€â˜ ï¸</span>
            <span class="selection-text">Pirate Adventure<br><small style="opacity: 0.8;">Ships, treasure & seas</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="outdoors">
            <span class="selection-icon">ğŸ•ï¸</span>
            <span class="selection-text">Great Outdoors<br><small style="opacity: 0.8;">Camping, hiking & nature</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="underwater">
            <span class="selection-icon">ğŸŒŠ</span>
            <span class="selection-text">Underwater World<br><small style="opacity: 0.8;">Mermaids, fish & coral</small></span>
        </button>
        <button type="button" class="selection-btn" data-value="castle">
            <span class="selection-icon">ğŸ°</span>
            <span class="selection-text">Medieval Castle<br><small style="opacity: 0.8;">Knights, princesses & quests</small></span>
        </button>
    </div>

    <div class="wizard-nav">
        <a href="{{ url_for('wizard_age') }}" class="nav-btn nav-btn-secondary">
            â† Previous
        </a>
        <button type="button" id="nextBtn" class="nav-btn nav-btn-primary" disabled>
            Next Step â†’
        </button>
    </div>
</form>
{% endblock %}

{% block wizard_scripts %}
<script>
// Store wizard data in sessionStorage
function saveWizardData(key, value) {
    let wizardData = JSON.parse(sessionStorage.getItem('wizardData') || '{}');
    wizardData[key] = value;
    sessionStorage.setItem('wizardData', JSON.stringify(wizardData));
}

function getWizardData(key) {
    let wizardData = JSON.parse(sessionStorage.getItem('wizardData') || '{}');
    return wizardData[key];
}

let selectedWorld = null;

// Handle world selection
document.querySelectorAll('.selection-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const value = this.getAttribute('data-value');
        
        // Remove active class from siblings
        document.querySelectorAll('.selection-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        // Add active class to clicked button
        this.classList.add('active');
        
        selectedWorld = value;
        saveWizardData('topic', value);
        
        // Enable next button
        document.getElementById('nextBtn').disabled = false;
        
        // Add visual feedback
        this.style.transform = 'scale(1.05)';
        setTimeout(() => {
            this.style.transform = '';
        }, 200);
    });
});

// Handle next button
document.getElementById('nextBtn').addEventListener('click', function() {
    if (this.disabled) return;
    
    // Validate selection before proceeding
    if (!selectedWorld) {
        alert('Please select a world for your adventure!');
        return;
    }
    
    // Validate against allowed topics
    const validTopics = ['space', 'community', 'dragons', 'fairies', 'pirates', 'outdoors', 'underwater', 'castle'];
    if (!validTopics.includes(selectedWorld)) {
        alert('Invalid world selection. Please choose a different world.');
        return;
    }
    
    // Navigate to next step
    window.location.href = '{{ url_for("wizard_length") }}';
});

// Load existing data if returning to this step
window.addEventListener('load', function() {
    const existingWorld = getWizardData('topic');
    
    if (existingWorld) {
        const worldBtn = document.querySelector(`[data-value="${existingWorld}"]`);
        if (worldBtn) {
            worldBtn.click();
        }
    }
});
</script>
{% endblock %}