{% extends "base.html" %}

{% block title %}{{ story.title }} - WonderTales{% endblock %}

{% block styles %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Theme Variables (same as other pages) */
    :root {
        --primary: #8B5CF6;
        --primary-dark: #6D28D9;
        --secondary: #EC4899;
        --accent: #14B8A6;
        --accent-light: #5EEAD4;
        --bg-main: #FFF7ED;
        --bg-card: #FFFFFF;
        --text-dark: #1F2937;
        --text-light: #6B7280;
        --shadow: rgba(139, 92, 246, 0.15);
    }

    [data-theme="magic-light"] {
        --primary: #8B5CF6;
        --primary-dark: #6D28D9;
        --secondary: #EC4899;
        --accent: #14B8A6;
        --accent-light: #5EEAD4;
        --bg-main: #FFF7ED;
        --bg-card: #FFFFFF;
        --text-dark: #1F2937;
        --text-light: #6B7280;
        --shadow: rgba(139, 92, 246, 0.15);
    }

    [data-theme="magic-dark"] {
        --primary: #A78BFA;
        --primary-dark: #8B5CF6;
        --secondary: #F472B6;
        --accent: #2DD4BF;
        --accent-light: #5EEAD4;
        --bg-main: #1F1B2E;
        --bg-card: #2D2640;
        --text-dark: #F3F4F6;
        --text-light: #D1D5DB;
        --shadow: rgba(167, 139, 250, 0.3);
    }

    [data-theme="sunny-light"] {
        --primary: #F59E0B;
        --primary-dark: #D97706;
        --secondary: #3B82F6;
        --accent: #FBBF24;
        --accent-light: #FDE68A;
        --bg-main: #FEF3C7;
        --bg-card: #FFFFFF;
        --text-dark: #1F2937;
        --text-light: #6B7280;
        --shadow: rgba(245, 158, 11, 0.15);
    }

    [data-theme="sunny-dark"] {
        --primary: #FCD34D;
        --primary-dark: #F59E0B;
        --secondary: #60A5FA;
        --accent: #FDE047;
        --accent-light: #FEF08A;
        --bg-main: #1E1B16;
        --bg-card: #2C2618;
        --text-dark: #F3F4F6;
        --text-light: #D1D5DB;
        --shadow: rgba(252, 211, 77, 0.3);
    }

    [data-theme="ocean-light"] {
        --primary: #0EA5E9;
        --primary-dark: #0284C7;
        --secondary: #FB7185;
        --accent: #34D399;
        --accent-light: #6EE7B7;
        --bg-main: #F0FDFA;
        --bg-card: #FFFFFF;
        --text-dark: #1F2937;
        --text-light: #6B7280;
        --shadow: rgba(14, 165, 233, 0.15);
    }

    [data-theme="ocean-dark"] {
        --primary: #38BDF8;
        --primary-dark: #0EA5E9;
        --secondary: #FDA4AF;
        --accent: #6EE7B7;
        --accent-light: #A7F3D0;
        --bg-main: #0F1419;
        --bg-card: #1A2332;
        --text-dark: #F3F4F6;
        --text-light: #D1D5DB;
        --shadow: rgba(56, 189, 248, 0.3);
    }

    body {
        font-family: 'Nunito', sans-serif;
        background: var(--bg-main);
        color: var(--text-dark);
        line-height: 1.8;
        min-height: 100vh;
        transition: background-color 0.4s ease, color 0.4s ease;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 24px;
    }

    /* Header */
    header {
        text-align: center;
        margin-bottom: 40px;
    }

    .logo {
        font-family: 'Fredoka', sans-serif;
        font-size: 42px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: inline-block;
        margin-bottom: 12px;
    }

    .tagline {
        font-size: 16px;
        color: var(--text-light);
        font-weight: 600;
        font-style: italic;
    }

    /* Story Display */
    .story-container {
        background: var(--bg-card);
        border-radius: 32px;
        padding: 60px;
        box-shadow: 0 8px 32px var(--shadow);
        transition: background-color 0.4s ease;
        margin-bottom: 40px;
    }

    .story-badge {
        display: inline-block;
        background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
        color: white;
        padding: 10px 24px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 24px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .story-title {
        font-family: 'Fredoka', sans-serif;
        font-size: 48px;
        font-weight: 700;
        margin-bottom: 32px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
    }

    .story-meta {
        display: flex;
        gap: 24px;
        margin-bottom: 40px;
        flex-wrap: wrap;
        padding-bottom: 24px;
        border-bottom: 3px solid var(--bg-main);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: var(--text-light);
        font-size: 15px;
    }

    .meta-icon {
        font-size: 20px;
    }

    .story-content {
        font-size: 22px;
        line-height: 1.9;
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 32px;
    }

    .story-content p {
        margin-bottom: 24px;
    }

    .story-content p:last-child {
        margin-bottom: 0;
    }

    .story-image {
        width: 100%;
        max-width: 500px;
        height: auto;
        border-radius: 20px;
        margin: 32px auto;
        display: block;
        box-shadow: 0 8px 24px var(--shadow);
    }

    .story-moral {
        background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
        color: white;
        padding: 24px 32px;
        border-radius: 20px;
        margin-top: 32px;
        text-align: center;
    }

    .moral-label {
        font-family: 'Fredoka', sans-serif;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        opacity: 0.9;
    }

    .moral-text {
        font-size: 20px;
        font-weight: 700;
        line-height: 1.6;
    }

    /* Action Buttons */
    .actions {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 40px;
    }

    .action-btn {
        padding: 20px 40px;
        font-family: 'Fredoka', sans-serif;
        font-size: 20px;
        font-weight: 700;
        border-radius: 16px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        min-height: 44px; /* Ensure minimum touch target */
        min-width: 44px; /* Ensure minimum touch target */
        position: relative;
        overflow: hidden;
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
    }

    .action-btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 8px 24px var(--shadow);
    }

    .action-btn-primary:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px var(--shadow);
    }

    .action-btn-primary:hover::before {
        opacity: 1;
    }

    .action-btn-primary:active {
        transform: translateY(-2px);
        transition: transform 0.1s ease;
    }

    .action-btn-secondary {
        background: var(--bg-card);
        color: var(--primary);
        border: 3px solid var(--primary);
    }

    .action-btn-secondary:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }

    .action-btn-secondary:active {
        transform: translateY(-1px);
        transition: transform 0.1s ease;
    }

    /* Voice Selection Buttons */
    .voice-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px 20px;
        background: var(--bg-card);
        border: 3px solid var(--accent-light);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Fredoka', sans-serif;
        font-size: 14px;
        font-weight: 700;
        color: var(--text-dark);
        min-width: 80px;
        min-height: 44px;
    }

    .voice-btn:hover {
        background: var(--accent-light);
        color: white;
        transform: translateY(-2px);
    }

    .voice-btn:active {
        transform: translateY(-1px);
        transition: transform 0.1s ease;
    }

    .voice-btn span:first-child {
        font-size: 24px;
    }

    /* Celebration Message */
    .celebration {
        text-align: center;
        background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
        color: white;
        padding: 40px;
        border-radius: 24px;
        margin-bottom: 40px;
    }

    .celebration-text {
        font-family: 'Fredoka', sans-serif;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .celebration-subtext {
        font-size: 18px;
        font-weight: 600;
        opacity: 0.95;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .story-container {
            padding: 40px 32px;
        }

        .story-title {
            font-size: 36px;
        }

        .story-content {
            font-size: 20px;
        }

        .action-btn {
            padding: 18px 32px;
            font-size: 18px;
            width: 100%;
            justify-content: center;
        }

        .logo {
            font-size: 36px;
        }

        .celebration-text {
            font-size: 24px;
        }
    }

    /* Tablet-specific optimizations for story display */
    @media (min-width: 768px) and (max-width: 1024px) {
        .container {
            max-width: 100%;
            padding: 40px 32px;
        }

        .story-container {
            padding: 64px 48px;
        }

        .story-title {
            font-size: 52px;
        }

        .story-content {
            font-size: 24px;
            line-height: 2;
        }

        .action-btn {
            padding: 24px 48px;
            font-size: 22px;
        }

        .celebration-text {
            font-size: 32px;
        }

        .celebration-subtext {
            font-size: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div class="logo">WonderTales</div>
        <p class="tagline">Adventure starts with your name</p>
    </header>

    <div class="celebration">
        <div class="celebration-text">üéâ You did it! üéâ</div>
        <div class="celebration-subtext">Your magical story is ready to read!</div>
    </div>

    <div class="story-container">
        <span class="story-badge">‚ú® Your Personal Adventure</span>
        
        <h1 class="story-title">{{ story.title }}</h1>
        
        <!-- Story metadata -->
        <div class="story-meta">
            <div class="meta-item">
                <span class="meta-icon">
                    {% if story.topic == 'space' %}üöÄ
                    {% elif story.topic == 'community' %}üèòÔ∏è
                    {% elif story.topic == 'dragons' %}üêâ
                    {% elif story.topic == 'fairies' %}üßö
                    {% elif story.topic == 'pirates' %}üè¥‚Äç‚ò†Ô∏è
                    {% elif story.topic == 'outdoors' %}üèïÔ∏è
                    {% elif story.topic == 'underwater' %}üåä
                    {% elif story.topic == 'castle' %}üè∞
                    {% else %}üåü
                    {% endif %}
                </span>
                <span>
                    {% if story.topic == 'space' %}Outer Space
                    {% elif story.topic == 'community' %}Community
                    {% elif story.topic == 'dragons' %}Dragon Land
                    {% elif story.topic == 'fairies' %}Fairy Garden
                    {% elif story.topic == 'pirates' %}Pirate Adventure
                    {% elif story.topic == 'outdoors' %}Great Outdoors
                    {% elif story.topic == 'underwater' %}Underwater World
                    {% elif story.topic == 'castle' %}Medieval Castle
                    {% else %}{{ story.topic.title() }}
                    {% endif %}
                </span>
            </div>
            <div class="meta-item">
                <span class="meta-icon">üìñ</span>
                <span>{{ story.story_length.title() }} Length</span>
            </div>
            <div class="meta-item">
                <span class="meta-icon">üéÇ</span>
                <span>Age {{ story.age_group }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-icon">üìù</span>
                <span>{{ story.word_count }} words</span>
            </div>
        </div>

        <!-- Story Elements Section -->
        {% if story.magic_tool or story.adventure_pack or story.animal_friend or story.topic %}
        <div style="background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%); color: white; padding: 24px 32px; border-radius: 20px; margin-bottom: 32px; text-align: center;">
            <div style="font-family: 'Fredoka', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 20px;">
                ‚ú® Your Story Elements ‚ú®
            </div>
            <div style="display: flex; gap: 24px; justify-content: center; flex-wrap: wrap;">
                <!-- World Theme -->
                {% if story.topic %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div style="font-size: 48px;">
                        {% if story.topic == 'space' %}üöÄ
                        {% elif story.topic == 'community' %}üèòÔ∏è
                        {% elif story.topic == 'dragons' %}üêâ
                        {% elif story.topic == 'fairies' %}üßö
                        {% elif story.topic == 'pirates' %}üè¥‚Äç‚ò†Ô∏è
                        {% elif story.topic == 'outdoors' %}üèïÔ∏è
                        {% elif story.topic == 'underwater' %}üåä
                        {% elif story.topic == 'castle' %}üè∞
                        {% else %}üåü
                        {% endif %}
                    </div>
                    <div style="font-weight: 600; font-size: 16px;">
                        {% if story.topic == 'space' %}Outer Space
                        {% elif story.topic == 'community' %}Community
                        {% elif story.topic == 'dragons' %}Dragon Land
                        {% elif story.topic == 'fairies' %}Fairy Garden
                        {% elif story.topic == 'pirates' %}Pirate Adventure
                        {% elif story.topic == 'outdoors' %}Great Outdoors
                        {% elif story.topic == 'underwater' %}Underwater World
                        {% elif story.topic == 'castle' %}Medieval Castle
                        {% else %}{{ story.topic.title() }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Magic Tool -->
                {% if story.magic_tool %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div style="font-size: 48px;">
                        {% if story.magic_tool == 'wand' %}ü™Ñ
                        {% elif story.magic_tool == 'sword' %}‚öîÔ∏è
                        {% elif story.magic_tool == 'bow' %}üèπ
                        {% elif story.magic_tool == 'staff' %}ü¶Ø
                        {% elif story.magic_tool == 'shield' %}üõ°Ô∏è
                        {% elif story.magic_tool == 'hammer' %}üî®
                        {% elif story.magic_tool == 'ring' %}üíç
                        {% elif story.magic_tool == 'orb' %}üîÆ
                        {% else %}‚ú®
                        {% endif %}
                    </div>
                    <div style="font-weight: 600; font-size: 16px;">
                        {% if story.magic_tool == 'wand' %}Magic Wand
                        {% elif story.magic_tool == 'sword' %}Brave Sword
                        {% elif story.magic_tool == 'bow' %}Magic Bow
                        {% elif story.magic_tool == 'staff' %}Crystal Staff
                        {% elif story.magic_tool == 'shield' %}Power Shield
                        {% elif story.magic_tool == 'hammer' %}Thunder Hammer
                        {% elif story.magic_tool == 'ring' %}Magic Ring
                        {% elif story.magic_tool == 'orb' %}Power Orb
                        {% else %}{{ story.magic_tool.replace('_', ' ').title() }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Adventure Pack -->
                {% if story.adventure_pack %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div style="font-size: 48px;">
                        {% if story.adventure_pack == 'backpack' %}üéí
                        {% elif story.adventure_pack == 'cape' %}ü¶∏
                        {% elif story.adventure_pack == 'boots' %}üë¢
                        {% elif story.adventure_pack == 'map' %}üó∫Ô∏è
                        {% elif story.adventure_pack == 'rope' %}ü™¢
                        {% elif story.adventure_pack == 'compass' %}üß≠
                        {% elif story.adventure_pack == 'lantern' %}üèÆ
                        {% elif story.adventure_pack == 'pouch' %}üëù
                        {% else %}üéí
                        {% endif %}
                    </div>
                    <div style="font-weight: 600; font-size: 16px;">
                        {% if story.adventure_pack == 'backpack' %}Magic Backpack
                        {% elif story.adventure_pack == 'cape' %}Flying Cape
                        {% elif story.adventure_pack == 'boots' %}Speed Boots
                        {% elif story.adventure_pack == 'map' %}Treasure Map
                        {% elif story.adventure_pack == 'rope' %}Magic Rope
                        {% elif story.adventure_pack == 'compass' %}Golden Compass
                        {% elif story.adventure_pack == 'lantern' %}Glowing Lantern
                        {% elif story.adventure_pack == 'pouch' %}Magic Pouch
                        {% else %}{{ story.adventure_pack.replace('_', ' ').title() }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Animal Friend -->
                {% if story.animal_friend %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div style="font-size: 48px;">
                        {% if story.animal_friend == 'wolf' %}üê∫
                        {% elif story.animal_friend == 'parrot' %}ü¶ú
                        {% elif story.animal_friend == 'owl' %}ü¶â
                        {% elif story.animal_friend == 'fox' %}ü¶ä
                        {% elif story.animal_friend == 'dragon' %}üêâ
                        {% elif story.animal_friend == 'unicorn' %}ü¶Ñ
                        {% elif story.animal_friend == 'eagle' %}ü¶Ö
                        {% elif story.animal_friend == 'cat' %}üê±
                        {% else %}üêæ
                        {% endif %}
                    </div>
                    <div style="font-weight: 600; font-size: 16px;">
                        {% if story.animal_friend == 'wolf' %}Brave Wolf
                        {% elif story.animal_friend == 'parrot' %}Wise Parrot
                        {% elif story.animal_friend == 'owl' %}Smart Owl
                        {% elif story.animal_friend == 'fox' %}Clever Fox
                        {% elif story.animal_friend == 'dragon' %}Baby Dragon
                        {% elif story.animal_friend == 'unicorn' %}Magic Unicorn
                        {% elif story.animal_friend == 'eagle' %}Golden Eagle
                        {% elif story.animal_friend == 'cat' %}Magic Cat
                        {% else %}{{ story.animal_friend.replace('_', ' ').title() }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Story image if available -->
        {% if story.image_url %}
        <img src="{{ story.image_url }}" alt="Story illustration" class="story-image">
        {% endif %}

        <!-- Story content -->
        <div class="story-content">
            {% set paragraphs = story.content.split('\n\n') %}
            {% if paragraphs|length > 1 %}
                <!-- Content has proper paragraph breaks -->
                {% for paragraph in paragraphs %}
                    {% if paragraph.strip() %}
                        <p>{{ paragraph.strip() }}</p>
                    {% endif %}
                {% endfor %}
            {% else %}
                <!-- Content is one block, clean up punctuation and create paragraph breaks -->
                {% set content_clean = story.content.strip() %}
                
                <!-- Fix common punctuation issues -->
                {% set content_clean = content_clean.replace(' .', '.') %}
                {% set content_clean = content_clean.replace(' !', '!') %}
                {% set content_clean = content_clean.replace(' ?', '?') %}
                {% set content_clean = content_clean.replace('  ', ' ') %}
                
                <!-- Fix missing spaces after punctuation (simple cases) -->
                {% for letter in 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
                    {% set content_clean = content_clean.replace('.' + letter, '. ' + letter) %}
                    {% set content_clean = content_clean.replace('!' + letter, '! ' + letter) %}
                    {% set content_clean = content_clean.replace('?' + letter, '? ' + letter) %}
                {% endfor %}
                
                <!-- Split at sentence boundaries -->
                {% set working_text = content_clean %}
                {% set working_text = working_text.replace('. ', '.<SPLIT>') %}
                {% set working_text = working_text.replace('! ', '!<SPLIT>') %}
                {% set working_text = working_text.replace('? ', '?<SPLIT>') %}
                
                {% set sentences = working_text.split('<SPLIT>') %}
                {% if sentences|length > 3 %}
                    <!-- Group sentences into paragraphs -->
                    {% set paragraph_size = 3 if story.age_group in ['3-4', '5-6'] else 4 %}
                    {% for i in range(0, sentences|length, paragraph_size) %}
                        {% set paragraph_sentences = sentences[i:i+paragraph_size] %}
                        {% if paragraph_sentences %}
                            {% set paragraph_text = ' '.join(paragraph_sentences).strip() %}
                            {% if paragraph_text %}
                                <p>{{ paragraph_text }}</p>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- Short content, display as single paragraph with cleaned punctuation -->
                    <p>{{ content_clean }}</p>
                {% endif %}
            {% endif %}
        </div>

        <!-- Story moral -->
        {% if story.moral %}
        <div class="story-moral">
            <div class="moral-label">‚ú® The Lesson ‚ú®</div>
            <div class="moral-text">{{ story.moral }}</div>
        </div>
        {% endif %}
    </div>

    <!-- First row of actions -->
    <div class="actions">
        <button id="readAloudBtn" class="action-btn action-btn-primary">
            <span>üîä</span>
            <span>Read My Story!</span>
        </button>
        <button id="stopReadingBtn" class="action-btn action-btn-secondary" style="display: none;">
            <span>‚èπÔ∏è</span>
            <span>Stop Reading</span>
        </button>
        <form method="POST" action="{{ url_for('print_story_post') }}" target="_blank" style="display: inline;">
            <input type="hidden" name="title" value="{{ story.title }}">
            <input type="hidden" name="content" value="{{ story.content }}">
            <input type="hidden" name="moral" value="{{ story.moral }}">
            <input type="hidden" name="topic" value="{{ story.topic }}">
            <input type="hidden" name="age_group" value="{{ story.age_group }}">
            <input type="hidden" name="story_length" value="{{ story.story_length }}">
            <input type="hidden" name="word_count" value="{{ story.word_count }}">
            <input type="hidden" name="magic_tool" value="{{ story.magic_tool }}">
            <input type="hidden" name="adventure_pack" value="{{ story.adventure_pack }}">
            <input type="hidden" name="animal_friend" value="{{ story.animal_friend }}">
            {% for character in story.characters %}
            <input type="hidden" name="character_{{ loop.index }}_name" value="{{ character.name }}">
            <input type="hidden" name="character_{{ loop.index }}_pronouns" value="{{ character.pronouns }}">
            {% endfor %}
            <button type="submit" class="action-btn action-btn-primary">
                <span>üñ®Ô∏è</span>
                <span>Print My Story</span>
            </button>
        </form>
    </div>

    <!-- Second row of actions -->
    <div class="actions">
        <a href="{{ url_for('landing') }}" class="action-btn action-btn-secondary">
            <span>üè†</span>
            <span>Home</span>
        </a>
        <a href="{% if came_from_wizard %}{{ url_for('wizard_characters') }}?clear=true{% else %}{{ url_for('index') }}{% endif %}" class="action-btn action-btn-primary">
            <span>‚ú®</span>
            <span>Create Another Story</span>
        </a>
    </div>

    <!-- Voice Selection (hidden by default) -->
    <div id="voiceSelection" style="display: none; text-align: center; margin-bottom: 20px;">
        <div style="font-family: 'Fredoka', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--primary);">
            üé≠ Choose a Voice!
        </div>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button class="voice-btn" data-voice="0">
                <span>üë©</span>
                <span>Friendly</span>
            </button>
            <button class="voice-btn" data-voice="1">
                <span>üë®</span>
                <span>Cheerful</span>
            </button>
            <button class="voice-btn" data-voice="2">
                <span>üåü</span>
                <span>Magical</span>
            </button>
        </div>
    </div>

    <div style="text-align: center; color: var(--text-light); font-weight: 600; font-size: 16px;">
        <p>Want to share your adventure?</p>
        <p style="margin-top: 8px;">Ask a grown-up to help you read it together! üìö</p>
    </div>
</div>

<script>
// Enhanced Text-to-Speech Story Reader with AI TTS and Browser Fallback
class StoryReader {
    constructor() {
        this.synth = window.speechSynthesis;
        this.voices = [];
        this.currentUtterance = null;
        this.currentAudio = null;
        this.isReading = false;
        this.storyText = '';
        this.useAITTS = false;
        this.aiVoices = {};
        
        // Get story text
        const storyContent = document.querySelector('.story-content');
        if (storyContent) {
            this.storyText = storyContent.innerText;
        }
        
        // Initialize TTS systems
        this.initializeTTS();
        
        // Setup event listeners
        this.setupEventListeners();
    }
    
    async initializeTTS() {
        // First, try to load AI TTS voices
        try {
            const response = await fetch('/tts/voices');
            const data = await response.json();
            
            if (data.available && data.voices) {
                this.useAITTS = true;
                this.aiVoices = data.voices;
                this.updateVoiceButtons();
                console.log('AI TTS voices loaded successfully');
            } else {
                console.log('AI TTS not available, falling back to browser TTS');
                this.initializeBrowserTTS();
            }
        } catch (error) {
            console.log('Failed to load AI TTS, using browser TTS:', error);
            this.initializeBrowserTTS();
        }
    }
    
    initializeBrowserTTS() {
        this.useAITTS = false;
        this.loadBrowserVoices();
        this.updateVoiceButtons();
    }
    
    loadBrowserVoices() {
        this.voices = this.synth.getVoices();
        
        // If voices aren't loaded yet, wait for them
        if (this.voices.length === 0) {
            this.synth.addEventListener('voiceschanged', () => {
                this.voices = this.synth.getVoices();
                this.selectChildFriendlyVoices();
            });
        } else {
            this.selectChildFriendlyVoices();
        }
    }
    
    selectChildFriendlyVoices() {
        // Try to find child-friendly voices
        this.childVoices = [];
        
        // Look for female voices (often sound more child-friendly)
        const femaleVoices = this.voices.filter(voice => 
            voice.name.toLowerCase().includes('female') || 
            voice.name.toLowerCase().includes('woman') ||
            voice.name.toLowerCase().includes('samantha') ||
            voice.name.toLowerCase().includes('karen') ||
            voice.name.toLowerCase().includes('susan')
        );
        
        // Look for male voices
        const maleVoices = this.voices.filter(voice => 
            voice.name.toLowerCase().includes('male') || 
            voice.name.toLowerCase().includes('man') ||
            voice.name.toLowerCase().includes('daniel') ||
            voice.name.toLowerCase().includes('alex') ||
            voice.name.toLowerCase().includes('tom')
        );
        
        // Add the best voices we can find
        if (femaleVoices.length > 0) this.childVoices.push(femaleVoices[0]);
        if (maleVoices.length > 0) this.childVoices.push(maleVoices[0]);
        
        // If we don't have specific voices, use the first few available
        if (this.childVoices.length < 3) {
            const defaultVoices = this.voices.slice(0, 3);
            defaultVoices.forEach(voice => {
                if (!this.childVoices.includes(voice)) {
                    this.childVoices.push(voice);
                }
            });
        }
        
        // Ensure we have at least one voice
        if (this.childVoices.length === 0 && this.voices.length > 0) {
            this.childVoices = [this.voices[0]];
        }
    }
    
    updateVoiceButtons() {
        const voiceButtons = document.querySelectorAll('.voice-btn');
        
        if (this.useAITTS) {
            // Update buttons for AI voices
            const voiceKeys = Object.keys(this.aiVoices);
            voiceButtons.forEach((btn, index) => {
                if (index < voiceKeys.length) {
                    const voiceKey = voiceKeys[index];
                    const voice = this.aiVoices[voiceKey];
                    btn.innerHTML = `<span>${voice.emoji}</span><span>${voice.name}</span>`;
                    btn.setAttribute('data-voice', voiceKey);
                    btn.title = voice.description;
                }
            });
        } else {
            // Keep original browser voice labels
            // The HTML already has the correct structure
        }
    }
    
    setupEventListeners() {
        const readBtn = document.getElementById('readAloudBtn');
        const stopBtn = document.getElementById('stopReadingBtn');
        const voiceSelection = document.getElementById('voiceSelection');
        
        if (readBtn) {
            readBtn.addEventListener('click', () => {
                if (!this.isReading) {
                    this.showVoiceSelection();
                } else {
                    this.pauseReading();
                }
            });
        }
        
        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                this.stopReading();
            });
        }
        
        // Voice selection buttons
        document.querySelectorAll('.voice-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const voiceId = btn.getAttribute('data-voice') || index.toString();
                this.startReading(voiceId);
                voiceSelection.style.display = 'none';
            });
        });
    }
    
    showVoiceSelection() {
        const voiceSelection = document.getElementById('voiceSelection');
        if (voiceSelection) {
            voiceSelection.style.display = 'block';
            voiceSelection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    async startReading(voiceId = 'friendly') {
        if (!this.storyText) return;
        
        // Stop any current reading
        this.stopReading();
        
        if (this.useAITTS) {
            await this.startAIReading(voiceId);
        } else {
            this.startBrowserReading(parseInt(voiceId) || 0);
        }
    }
    
    async startAIReading(voiceKey) {
        try {
            this.isReading = true;
            this.updateButtons();
            
            // Show loading state
            const readBtn = document.getElementById('readAloudBtn');
            if (readBtn) {
                readBtn.innerHTML = '<span>‚è≥</span><span>Loading...</span>';
            }
            
            // Generate audio
            const response = await fetch('/tts/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: this.storyText,
                    voice: voiceKey
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData.fallback) {
                    console.log('AI TTS failed, falling back to browser TTS');
                    this.useAITTS = false;
                    this.initializeBrowserTTS();
                    this.startBrowserReading(0);
                    return;
                }
                throw new Error('Failed to generate audio');
            }
            
            // Create audio element and play
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            
            this.currentAudio = new Audio(audioUrl);
            
            this.currentAudio.onplay = () => {
                this.isReading = true;
                this.updateButtons();
            };
            
            this.currentAudio.onended = () => {
                this.isReading = false;
                this.updateButtons();
                URL.revokeObjectURL(audioUrl);
            };
            
            this.currentAudio.onerror = () => {
                console.error('Audio playback error, falling back to browser TTS');
                this.isReading = false;
                this.updateButtons();
                URL.revokeObjectURL(audioUrl);
                
                // Fallback to browser TTS
                this.useAITTS = false;
                this.initializeBrowserTTS();
                this.startBrowserReading(0);
            };
            
            await this.currentAudio.play();
            
        } catch (error) {
            console.error('AI TTS error:', error);
            this.isReading = false;
            this.updateButtons();
            
            // Fallback to browser TTS
            this.useAITTS = false;
            this.initializeBrowserTTS();
            this.startBrowserReading(0);
        }
    }
    
    startBrowserReading(voiceIndex = 0) {
        if (!this.synth || !this.storyText) return;
        
        // Create new utterance
        this.currentUtterance = new SpeechSynthesisUtterance(this.storyText);
        
        // Set voice if available
        if (this.childVoices && this.childVoices[voiceIndex]) {
            this.currentUtterance.voice = this.childVoices[voiceIndex];
        }
        
        // Configure speech settings for children
        this.currentUtterance.rate = 0.8; // Slightly slower for kids
        this.currentUtterance.pitch = 1.1; // Slightly higher pitch
        this.currentUtterance.volume = 0.9;
        
        // Event listeners
        this.currentUtterance.onstart = () => {
            this.isReading = true;
            this.updateButtons();
        };
        
        this.currentUtterance.onend = () => {
            this.isReading = false;
            this.updateButtons();
        };
        
        this.currentUtterance.onerror = () => {
            this.isReading = false;
            this.updateButtons();
            console.error('Speech synthesis error');
        };
        
        // Start speaking
        this.synth.speak(this.currentUtterance);
    }
    
    pauseReading() {
        if (this.useAITTS && this.currentAudio) {
            if (this.currentAudio.paused) {
                this.currentAudio.play();
            } else {
                this.currentAudio.pause();
            }
        } else if (this.synth && this.synth.speaking) {
            if (this.synth.paused) {
                this.synth.resume();
            } else {
                this.synth.pause();
            }
        }
    }
    
    stopReading() {
        if (this.useAITTS && this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio.currentTime = 0;
            this.currentAudio = null;
        } else if (this.synth && this.synth.speaking) {
            this.synth.cancel();
        }
        
        this.isReading = false;
        this.updateButtons();
    }
    
    updateButtons() {
        const readBtn = document.getElementById('readAloudBtn');
        const stopBtn = document.getElementById('stopReadingBtn');
        
        if (this.isReading) {
            if (readBtn) {
                readBtn.innerHTML = '<span>‚è∏Ô∏è</span><span>Pause</span>';
                readBtn.style.display = 'inline-flex';
            }
            if (stopBtn) {
                stopBtn.style.display = 'inline-flex';
            }
        } else {
            if (readBtn) {
                readBtn.innerHTML = '<span>üîä</span><span>Read My Story!</span>';
                readBtn.style.display = 'inline-flex';
            }
            if (stopBtn) {
                stopBtn.style.display = 'none';
            }
        }
    }
}

// Initialize story reader when page loads
document.addEventListener('DOMContentLoaded', function() {
    new StoryReader();
});
</script>

{% endblock %}